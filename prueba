
Sub macroserieafc()


Dim hojaOrigen As Worksheet, hojaDestino As Worksheet
Dim RangoHoja As String
Dim Wsht As Worksheet
Dim archivo As String
Dim startValue As Integer
Dim endValue As Integer
Dim ws As Worksheet

Application.ScreenUpdating = False


Application.Run "mostrarhojas"
Application.Run "descargaa"
Application.Run "abrirarchivosaficha"


Application.ScreenUpdating = False

Dim a, i, c, col, ok, colcodigocomuna, filacodigocomuna, fila, filamacro, X, confirmaestablecimiento As Integer
Dim mes1, mes2, confirma As Integer
Dim cadenames, cadena As String
col = 3
fila = 3
a = 1
filamacro = 2
colmacro = 2
filacodigocomuna = 2
colcodigocomuna = 3
confirmaestablecimiento = 2
ok = 2

Set ws = ThisWorkbook.Sheets("Establecimientos")
startValue = ws.Range("K2").Value
endValue = ws.Range("L2").Value

archivo = Workbooks("Macro2023v1.2.xlsm").Sheets("Arangosdeis").Range("F2").Value

Windows("Macro2023v1.2.xlsm").Activate
cadena = Worksheets("Meses").Range("a22").Value

If Len(cadena) = 6 Then
               For i = 1 To Len(cadena)

                            'Evaluar SI el carácter actual es un número
                            If IsNumeric(Mid(cadena, i, 1)) Then
                                Windows(archivo).Activate 'MODIFICAR SEGUN SERIE
                                Sheets("NOMBRE").Activate
                                            ActiveSheet.Cells(fila, col).Value = Mid(cadena, i, 1)
                             
                            End If
                            col = col + 1
                Next
                
                            
                For filamacro = startValue To endValue
                
                Windows("Macro2023v1.2.xlsm").Activate
                Sheets("Establecimientos").Activate
                
                ActiveSheet.Cells(filamacro, colmacro).Select
                imprimir = ActiveSheet.Cells(filamacro, colmacro).Value
                                   
                  
                    If imprimir = cadena Then
                        confirmaestablecimiento = 1
                                    
                                    
                                    
                                  ESTABLECIMIENTO = ActiveSheet.Cells(filamacro, colmacro + 1).Value
                                  comuna = ActiveSheet.Cells(filamacro, colmacro + 2).Value
                                  codigocomuna = ActiveSheet.Cells(filamacro, colmacro + 3).Value
                                
                                  Windows(archivo).Activate 'MODIFICAR SEGUN SERIE
                                         Sheets("NOMBRE").Activate
                                  
                                  ActiveSheet.Cells(3, 2).Value = ESTABLECIMIENTO
                                  ActiveSheet.Cells(2, 2).Value = comuna

                               
                                    
                                    
                                    For c = 1 To Len(codigocomuna)
                                                                     
                                            If IsNumeric(Mid(codigocomuna, c, 1)) Then
                                            
                                                ActiveSheet.Cells(filacodigocomuna, colcodigocomuna).Value = Mid(codigocomuna, c, 1)
                                                
                                            End If
                                            colcodigocomuna = colcodigocomuna + 1
                                    Next
                                    
                                     Windows("Macro2023v1.2.xlsm").Activate
                                 Sheets("Establecimientos").Activate
                                   dependencia = ActiveSheet.Cells(filamacro, colmacro + 4).Value
                                   
                                    Windows(archivo).Activate 'MODIFICAR SEGUN SERIE
                                         Sheets("NOMBRE").Activate
                                   ActiveSheet.Cells(5, 2).Value = dependencia
                                    
                                    
                    End If
                     
                Next
                 

                 
                 
                 
                 
                 
If confirmaestablecimiento = 2 Then
Application.Run "ocultarhojas"
MsgBox "No es un Código Correcto o es un establecimiento nuevo el cual no se encuentra en la lista, favor comunicarse a aarellano@ssmaule.cl  VERIFIQUELA", vbCritical

End If


                
If confirmaestablecimiento = 1 Then
                

cadenames = Worksheets("Meses").Range("a23").Value
        
        'Evaluar SI el carácter actual es un número
    If IsNumeric(Mid(cadena, i, 1)) Then
                Application.Run "ocultarhojas"
                 MsgBox "la cadena de Texto contiene Números o espacios No válidos, VERIFIQUELA", vbCritical
                confirmaestablecimiento = 2
    
    Else
                            
                            Windows("Macro2023v1.2.xlsm").Activate
                            Sheets("Meses").Activate
                            filamacro = 1
                            colmacro = 1
                             
                             confirmaminusculas = 2
                             confirmaestablecimiento = 2
                             
                            For filamacro = 1 To 12
                            
                                
                                
                                ActiveSheet.Cells(filamacro, colmacro).Select
                                imprimir = ActiveSheet.Cells(filamacro, colmacro).Value
                                                    
                                    If imprimir = cadenames Then
                                
                                         mes1 = ActiveSheet.Cells(filamacro, colmacro + 1).Value
                                         mes2 = ActiveSheet.Cells(filamacro, colmacro + 2).Value
                                        
                                        
                                         Windows(archivo).Activate 'MODIFICAR SEGUN SERIE
                                         Sheets("NOMBRE").Activate
                                         ActiveSheet.Cells(6, 2).Value = cadenames
                                         ActiveSheet.Cells(6, 3).Value = mes1
                                         ActiveSheet.Cells(6, 4).Value = mes2
                                         
                                         confirmaminusculas = 1
                                         confirmaestablecimiento = 1
                                    End If
                            Next
                                       
                                       
                            If confirmaminusculas = 2 Then
                                  'mes con letras minusculas
                                  Windows("Macro2023v1.2.xlsm").Activate
                                    Sheets("Meses").Activate
                                    filamacro = 2
                                    colmacro = 4
                                                            
                                    For filamacro = 1 To 12
                                        
                                            ActiveSheet.Cells(filamacro, colmacro).Select
                                            imprimir = ActiveSheet.Cells(filamacro, colmacro).Value
                                                                                       
                                            If imprimir = cadenames Then
                                                            
                                                    mes1 = ActiveSheet.Cells(filamacro, colmacro + 2).Value
                                                    mes2 = ActiveSheet.Cells(filamacro, colmacro + 3).Value
                                                    cadenames = ActiveSheet.Cells(filamacro, colmacro + 1).Value
                                                    
                                                    Windows(archivo).Activate 'MODIFICAR SEGUN SERIE
                                                    Sheets("NOMBRE").Activate
                                                    ActiveSheet.Cells(6, 2).Value = cadenames
                                                    ActiveSheet.Cells(6, 3).Value = mes1
                                                    ActiveSheet.Cells(6, 4).Value = mes2
                                                    
                                                    confirmaminusculas = 1
                                                    confirmaestablecimiento = 1
                                            End If
                                    Next
                            End If
                                
                            If confirmaminusculas = 2 Then
                                  'mes con letras mayusculas
                                    Windows("Macro2023v1.2.xlsm").Activate
                                    Sheets("Meses").Activate
                                    filamacro = 2
                                    colmacro = 8
                                                            
                                    For filamacro = 1 To 12
                                            
                                            ActiveSheet.Cells(filamacro, colmacro).Select
                                            imprimir = ActiveSheet.Cells(filamacro, colmacro).Value
                                                                                       
                                            If imprimir = cadenames Then
                                                            
                                                    mes1 = ActiveSheet.Cells(filamacro, colmacro + 1).Value
                                                    mes2 = ActiveSheet.Cells(filamacro, colmacro + 2).Value
                                                    cadenames = ActiveSheet.Cells(filamacro, colmacro - 3).Value
                                                    
                                                    Windows(archivo).Activate 'MODIFICAR SEGUN SERIE
                                                    Sheets("NOMBRE").Activate
                                                    ActiveSheet.Cells(6, 2).Value = cadenames
                                                    ActiveSheet.Cells(6, 3).Value = mes1
                                                    ActiveSheet.Cells(6, 4).Value = mes2
                                                    
                                                    confirmaminusculas = 1
                                                    confirmaestablecimiento = 1
                                            End If
                                
                                    Next
                            End If
                            
                            If confirmaminusculas = 2 Then
                                                
                                    Windows("Macro2023v1.2.xlsm").Activate
                                    Sheets("Meses").Activate
                                    
                                    filamacro = 2
                                    colmacro = 11
                                                            
                                    For filamacro = 1 To 12
                                            
                                            
                                            
                                            ActiveSheet.Cells(filamacro, colmacro).Select
                                            imprimir = ActiveSheet.Cells(filamacro, colmacro).Value
                                                                                       
                                            If imprimir = cadenames Then
                                                            
                                                    mes1 = ActiveSheet.Cells(filamacro, colmacro + 1).Value
                                                    mes2 = ActiveSheet.Cells(filamacro, colmacro + 2).Value
                                                    cadenames = ActiveSheet.Cells(filamacro, colmacro - 6).Value
                                                    
                                                    Windows(archivo).Activate 'MODIFICAR SEGUN SERIE
                                                    Sheets("NOMBRE").Activate
                                                    ActiveSheet.Cells(6, 2).Value = cadenames
                                                    ActiveSheet.Cells(6, 3).Value = mes1
                                                    ActiveSheet.Cells(6, 4).Value = mes2
                                                    
                                                    confirmaminusculas = 1
                                                    confirmaestablecimiento = 1
                                            End If
                                    Next
                            End If
                            
                            
               If confirmaminusculas = 2 Then
               Application.Run "ocultarhojas"
                MsgBox "la cadena de Texto no corresponde a un mes válido, VERIFIQUELA. escribió: " & cadenames, vbCritical
                
               End If
    End If

End If

Else
Application.Run "ocultarhojas"
MsgBox "Debe ingresar un Código válido de 6 dígitos, VERIFIQUELO. escribió: " & cadena, vbCritical
confirmaestablecimiento = 2
End If



'------------------------------------------copia------------------------------------

Application.Run "copiaserieaficha"
Application.Run "LimpiarCeldas"

'------------------------------------------Protege libro------------------------------------


    'protege libro serie
    Windows(archivo).Activate                                        'modificar segun serie
    For Each Wsht In ActiveWorkbook.Worksheets
    Wsht.Protect password:="e45.321rT-a"                                 'modificar segun serie
    Next Wsht
        

Application.Run "cerraraficha"

Windows(archivo).Activate
    Sheets("NOMBRE").Select
     
Application.Calculation = xlCalculationAutomatic
    

 'ASIGNA AL NOMBRE DEL ARCHIVO EL CODIGO DE MES
    
    nombre = cadena & "A" & Range("c6") & "" & Range("d6") & ".xlsm"
            ActiveWorkbook.SaveAs nombre, FileFormat _
            :=xlOpenXMLWorkbookMacroEnabled, CreateBackup:=False
        

   Application.ScreenUpdating = False


Sheets("NOMBRE").Select
              
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
     ActiveWorkbook.Save
     
            Application.Run "ocultarhojas"
            MsgBox "¡PROCESO TERMINADO! Archivo: " & cadena & " Creado en la ruta de sus archivos. Debe seleccionar tipo establecimiento en hoja nombre.", vbInformation, "Confirmación"
           ActiveWindow.DisplayHeadings = True
ActiveWindow.DisplayGridlines = True
    Application.Quit
    ActiveWorkbook.Close

End Sub

















